defmodule Plausible.Imported.CSVImporterTest do
  use Plausible.DataCase, async: true

  doctest Plausible.Imported.CSVImporter, import: true

  @moduletag :minio

  # uses https://min.io
  # docker run -d --rm -p 9000:9000 -p 9001:9001 --name minio minio/minio server /data --console-address ":9001"
  # docker exec minio mc alias set local http://localhost:9000 minioadmin minioadmin
  # docker exec minio mc mb local/imports

  alias Plausible.Imported.{CSVImporter, SiteImport}
  require SiteImport

  describe "new_import/3 and parse_args/1" do
    setup [:create_user, :create_new_site]

    test "parses job args properly", %{user: user, site: site} do
      tables = [
        "imported_browsers",
        "imported_devices",
        "imported_entry_pages",
        "imported_exit_pages",
        "imported_locations",
        "imported_operating_systems",
        "imported_pages",
        "imported_sources",
        "imported_visitors"
      ]

      uploads =
        Enum.map(tables, fn table ->
          filename = "#{table}.csv"
          s3_path = "#{site.id}/#{filename}"
          %{"filename" => filename, "s3_path" => s3_path}
        end)

      assert {:ok, job} =
               CSVImporter.new_import(site, user,
                 # to satisfy the non null constraints on the table I'm providing "0" dates (according to ClickHouse)
                 start_date: ~D[1970-01-01],
                 end_date: ~D[1970-01-01],
                 uploads: uploads
               )

      assert %Oban.Job{args: %{"import_id" => import_id, "uploads" => ^uploads} = args} =
               Repo.reload!(job)

      assert [
               %{
                 id: ^import_id,
                 source: :csv,
                 start_date: ~D[1970-01-01],
                 end_date: ~D[1970-01-01],
                 status: SiteImport.pending()
               }
             ] = Plausible.Imported.list_all_imports(site)

      assert %{imported_data: nil} = Repo.reload!(site)
      assert CSVImporter.parse_args(args) == [uploads: uploads]
    end
  end

  describe "import_data/2" do
    setup [:create_user, :create_new_site]

    test "imports tables from S3", %{site: site, user: user} do
      csvs = [
        %{
          name: "imported_browsers.csv",
          body: """
          "date","browser","visitors","visits","visit_duration","bounces"
          "2021-12-30","Amazon Silk",2,2,0,2
          "2021-12-30","Chrome",31,32,329,29
          "2021-12-30","Edge",3,3,0,3
          "2021-12-30","Firefox",1,1,0,1
          "2021-12-30","Internet Explorer",1,1,0,1
          "2021-12-30","Mobile App",2,2,0,2
          "2021-12-30","Mobile App",4,4,0,4
          "2021-12-30","Mobile App",1,1,0,1
          "2021-12-30","Safari",32,36,0,36
          "2021-12-30","Samsung Internet",2,2,0,2
          "2021-12-30","UC Browser",1,1,0,1
          "2021-12-31","Chrome",24,25,75,23
          "2021-12-31","Edge",3,3,0,3
          "2021-12-31","Firefox",1,1,466,0
          "2021-12-31","Mobile App",4,5,0,5
          "2021-12-31","Mobile App",4,4,0,4
          "2021-12-31","Mobile App",1,1,85,0
          "2021-12-31","Safari",37,45,1957,42
          "2021-12-31","Samsung Internet",1,1,199,0
          "2022-01-01","'DuckDuckBot-Https",17,18,0,18
          "2022-01-01","Chrome",30,33,1149,29
          "2022-01-01","Edge",1,1,0,1
          "2022-01-01","Firefox",1,1,0,1
          "2022-01-01","Mobile App",1,1,0,1
          "2022-01-01","Mobile App",5,5,0,5
          "2022-01-01","Mobile App",2,2,0,2
          "2022-01-01","Opera",1,1,0,1
          "2022-01-01","Safari",36,38,693,33
          "2022-01-01","Samsung Internet",2,2,0,2
          "2022-01-02","Chrome",38,38,1411,34
          "2022-01-02","Firefox",2,2,0,2
          "2022-01-02","Mobile App",3,3,36,2
          "2022-01-02","Mobile App",9,9,0,9
          "2022-01-02","Mobile App",1,1,0,1
          "2022-01-02","Safari",50,57,1089,52
          "2022-01-03","Chrome",35,40,2067,34
          "2022-01-03","Edge",3,3,0,3
          "2022-01-03","Firefox",1,1,105,0
          "2022-01-03","Mobile App",3,3,124,2
          "2022-01-03","Mobile App",10,10,137,9
          "2022-01-03","Mobile App",1,1,0,1
          "2022-01-03","Safari",53,55,5786,45
          "2022-01-03","Samsung Internet",2,2,0,2
          "2022-01-04","Amazon Silk",1,1,0,1
          "2022-01-04","Chrome",22,23,250,21
          "2022-01-04","Edge",3,3,0,3
          "2022-01-04","Firefox",1,1,0,1
          "2022-01-04","Mobile App",1,1,0,1
          "2022-01-04","Mobile App",12,12,248,9
          "2022-01-04","Mobile App",1,1,0,1
          "2022-01-04","Mobile App",1,1,0,1
          "2022-01-04","Opera",1,1,0,1
          "2022-01-04","Safari",43,47,1806,43
          "2022-01-04","Samsung Internet",1,1,0,1
          "2022-01-05","Chrome",36,39,1133,34
          "2022-01-05","Edge",3,3,0,3
          "2022-01-05","Firefox",2,2,0,2
          "2022-01-05","Mobile App",1,1,147,0
          "2022-01-05","Mobile App",1,1,0,1
          "2022-01-05","Safari",38,38,1125,36
          "2022-01-05","Samsung Internet",1,1,0,1
          "2022-01-06","'DuckDuckBot-Https",18,18,0,18
          "2022-01-06","Chrome",36,37,1897,32
          "2022-01-06","Edge",2,2,10,1
          "2022-01-06","Firefox",1,1,0,1
          "2022-01-06","Internet Explorer",1,1,0,1
          "2022-01-06","Mobile App",1,1,0,1
          "2022-01-06","Mobile App",8,8,0,8
          "2022-01-06","Mobile App",2,2,0,2
          "2022-01-06","Safari",40,45,1206,42
          "2022-01-06","iubenda-radar",5,5,0,5
          "2022-01-07","Chrome",25,26,630,23
          "2022-01-07","Edge",1,1,0,1
          "2022-01-07","Firefox",1,1,0,1
          "2022-01-07","Safari",32,33,856,30
          "2022-01-07","Samsung Internet",3,3,0,3
          "2022-01-07","YaBrowser",1,1,0,1
          "2022-01-08","Chrome",33,33,229,31
          "2022-01-08","Edge",3,3,1700,2
          "2022-01-08","Firefox",1,1,94,0
          "2022-01-08","Mobile App",1,1,0,1
          "2022-01-08","Mobile App",4,4,10,3
          "2022-01-08","Mobile App",2,2,0,2
          "2022-01-08","Opera",1,1,0,1
          "2022-01-08","Safari",47,51,4070,45
          "2022-01-09","Amazon Silk",1,1,0,1
          "2022-01-09","Chrome",23,25,1012,20
          "2022-01-09","Edge",4,4,0,4
          "2022-01-09","Mobile App",3,4,16,3
          "2022-01-09","Mobile App",11,12,203,9
          "2022-01-09","Mobile App",1,1,0,1
          "2022-01-09","Safari",42,46,636,44
          "2022-01-09","Samsung Internet",2,2,0,2
          "2022-01-10","Amazon Silk",1,1,0,1
          "2022-01-10","Chrome",18,19,0,19
          "2022-01-10","Edge",1,1,0,1
          "2022-01-10","Firefox",2,2,0,2
          "2022-01-10","Mobile App",1,1,0,1
          "2022-01-10","Mobile App",4,4,0,4
          "2022-01-10","Safari",41,44,160,41
          """
        },
        %{
          name: "imported_devices.csv",
          body: """
          "date","device","visitors","visits","visit_duration","bounces"
          "2021-12-30","Desktop",25,28,75,27
          "2021-12-30","Mobile",49,51,254,49
          "2021-12-30","Tablet",6,6,0,6
          "2021-12-31","Desktop",20,26,496,24
          "2021-12-31","Mobile",50,54,1842,49
          "2021-12-31","Tablet",5,5,444,4
          "2022-01-01","Desktop",33,34,1117,32
          "2022-01-01","Mobile",55,60,306,54
          "2022-01-01","Tablet",8,8,419,7
          "2022-01-02","Desktop",28,28,86,26
          "2022-01-02","Mobile",66,73,2450,65
          "2022-01-02","Tablet",9,9,0,9
          "2022-01-03","Desktop",37,37,1855,30
          "2022-01-03","Mobile",64,68,6364,56
          "2022-01-03","Tablet",7,10,0,10
          "2022-01-04","Desktop",26,26,1330,22
          "2022-01-04","Mobile",58,63,954,59
          "2022-01-04","Tablet",3,3,20,2
          "2022-01-05","Desktop",30,32,1162,29
          "2022-01-05","Mobile",45,46,1084,43
          "2022-01-05","Tablet",7,7,159,5
          "2022-01-06","Desktop",53,53,114,51
          "2022-01-06","Mobile",55,61,2999,54
          "2022-01-06","Tablet",6,6,0,6
          "2022-01-07","Desktop",15,16,247,15
          "2022-01-07","Mobile",47,48,1239,43
          "2022-01-07","Tablet",1,1,0,1
          "2022-01-08","Desktop",27,28,2171,23
          "2022-01-08","Mobile",59,63,3932,57
          "2022-01-08","Tablet",5,5,0,5
          "2022-01-09","Desktop",31,33,1415,26
          "2022-01-09","Mobile",48,54,167,51
          "2022-01-09","Tablet",8,8,285,7
          "2022-01-10","Desktop",22,24,0,24
          "2022-01-10","Mobile",46,49,160,46
          "2022-01-10","Tablet",4,4,0,4
          "2022-01-11","Desktop",29,30,1835,23
          "2022-01-11","Mobile",39,40,185,35
          "2022-01-11","Tablet",10,10,0,10
          "2022-01-12","Desktop",16,16,1543,14
          "2022-01-12","Mobile",61,66,2113,57
          "2022-01-12","Tablet",7,7,18,6
          "2022-01-13","Desktop",34,35,3000,29
          "2022-01-13","Mobile",47,51,262,48
          "2022-01-13","Tablet",5,5,0,5
          "2022-01-14","Desktop",21,21,5,20
          "2022-01-14","Mobile",52,60,178,58
          "2022-01-14","Tablet",3,3,0,3
          "2022-01-15","Desktop",22,22,347,21
          "2022-01-15","Mobile",73,76,3633,72
          "2022-01-15","Tablet",4,4,231,3
          "2022-01-16","Desktop",30,34,829,30
          "2022-01-16","Mobile",64,65,2438,56
          "2022-01-16","Tablet",9,10,1449,9
          "2022-01-17","Desktop",41,42,550,39
          "2022-01-17","Mobile",59,65,2177,59
          "2022-01-17","Tablet",4,4,0,4
          "2022-01-18","Desktop",18,21,176,20
          "2022-01-18","Mobile",46,49,3004,42
          "2022-01-18","Tablet",4,4,117,3
          "2022-01-19","Desktop",15,15,0,15
          "2022-01-19","Mobile",49,53,3145,44
          "2022-01-19","Tablet",3,3,0,3
          "2022-01-20","Desktop",25,25,2734,20
          "2022-01-20","Mobile",41,45,1585,43
          "2022-01-20","Tablet",3,3,0,3
          "2022-01-21","Desktop",43,44,3041,39
          "2022-01-21","Mobile",47,52,2183,46
          "2022-01-21","Tablet",4,4,0,4
          "2022-01-22","Desktop",24,25,682,19
          "2022-01-22","Mobile",63,67,3209,55
          "2022-01-22","Tablet",3,3,591,2
          "2022-01-23","Desktop",20,20,594,18
          "2022-01-23","Mobile",64,70,2059,65
          "2022-01-23","Tablet",2,2,0,2
          "2022-01-24","Desktop",27,27,2004,25
          "2022-01-24","Mobile",58,62,659,56
          "2022-01-24","Tablet",5,5,0,5
          "2022-01-25","Desktop",32,37,280,34
          "2022-01-25","Mobile",34,36,467,30
          "2022-01-25","Tablet",4,4,0,4
          "2022-01-26","Desktop",14,15,0,15
          "2022-01-26","Mobile",57,61,4114,55
          "2022-01-26","Tablet",3,3,0,3
          "2022-01-27","Desktop",38,39,692,37
          "2022-01-27","Mobile",52,56,1237,49
          "2022-01-27","Tablet",2,2,0,2
          "2022-01-28","Desktop",18,20,161,18
          "2022-01-28","Mobile",56,62,0,62
          "2022-01-28","Tablet",2,3,0,3
          "2022-01-29","Desktop",32,32,946,29
          "2022-01-29","Mobile",66,69,2403,63
          "2022-01-29","Tablet",2,2,0,2
          "2022-01-30","Desktop",30,31,1189,28
          "2022-01-30","Mobile",56,59,2253,54
          "2022-01-30","Tablet",5,5,283,4
          "2022-01-31","Desktop",31,32,0,32
          "2022-01-31","Mobile",46,52,1515,46
          "2022-01-31","Tablet",2,2,382,1
          "2022-02-01","Desktop",26,26,211,23
          """
        },
        %{
          name: "imported_entry_pages.csv",
          body: """
          "date","visitors","entrances","visit_duration","bounces","entry_page"
          "2021-12-30",6,6,0,6,"/14776416252794997127"
          "2021-12-30",1,1,0,1,"/15455127321321119046"
          "2021-12-30",1,1,43,0,"/10399835914295020763"
          "2021-12-30",1,1,0,1,"/9102354072466236765"
          "2021-12-30",1,1,0,1,"/4457889102355683190"
          "2021-12-30",1,1,0,1,"/12105301321223776356"
          "2021-12-30",1,2,0,2,"/1526239929864936398"
          "2021-12-30",3,3,0,3,"/12574817671425987843"
          "2021-12-30",1,1,0,1,"/18226692671132987727"
          "2021-12-30",1,1,0,1,"/13530392472417087202"
          "2021-12-30",3,3,0,3,"/14629996869565295116"
          "2021-12-30",2,2,0,2,"/16500758973580097263"
          "2021-12-30",3,3,0,3,"/12300842990999856228"
          "2021-12-30",2,2,75,1,"/17859765562822550514"
          "2021-12-30",1,1,0,1,"/1250717791477281255"
          "2021-12-30",1,1,0,1,"/1586391735863371077"
          "2021-12-30",1,1,0,1,"/3457026921000639206"
          "2021-12-30",2,3,0,3,"/6077502147861556415"
          "2021-12-30",1,1,0,1,"/14280570555317344651"
          "2021-12-30",3,3,0,3,"/5284268072698982201"
          "2021-12-30",1,1,0,1,"/7478911940502018071"
          "2021-12-30",1,1,0,1,"/6402607186523575652"
          "2021-12-30",2,2,0,2,"/9962503789684934900"
          "2021-12-30",8,10,0,10,"/13595620304963848161"
          "2021-12-30",2,2,0,2,"/17019199732013993436"
          "2021-12-30",31,31,211,30,"/9874837495456455794"
          "2021-12-31",4,4,0,4,"/14776416252794997127"
          "2021-12-31",1,1,0,1,"/8738789417178304429"
          "2021-12-31",1,1,0,1,"/7445073500314667742"
          "2021-12-31",1,1,0,1,"/4897404798407749335"
          "2021-12-31",1,1,45,0,"/11263893625781431659"
          "2021-12-31",1,1,0,1,"/16478773157730928089"
          "2021-12-31",1,1,0,1,"/1710995203264225236"
          "2021-12-31",2,3,0,3,"/12574817671425987843"
          "2021-12-31",1,2,0,2,"/4072002299714740082"
          "2021-12-31",1,1,0,1,"/13544703054662457518"
          "2021-12-31",1,1,0,1,"/3363270934034278688"
          "2021-12-31",4,4,0,4,"/14629996869565295116"
          "2021-12-31",2,2,284,0,"/5918158559063394909"
          "2021-12-31",1,1,0,1,"/16500758973580097263"
          "2021-12-31",1,1,0,1,"/15335700069940448722"
          "2021-12-31",7,7,0,7,"/1250717791477281255"
          "2021-12-31",3,3,0,3,"/3457026921000639206"
          "2021-12-31",1,1,0,1,"/6077502147861556415"
          "2021-12-31",1,1,0,1,"/14280570555317344651"
          "2021-12-31",4,5,444,4,"/5284268072698982201"
          "2021-12-31",2,2,466,1,"/7478911940502018071"
          "2021-12-31",9,16,1455,15,"/13595620304963848161"
          "2021-12-31",25,25,88,23,"/9874837495456455794"
          "2022-01-01",2,3,0,3,"/14776416252794997127"
          "2022-01-01",1,1,0,1,"/18394065791342797546"
          "2022-01-01",2,2,0,2,"/9102354072466236765"
          "2022-01-01",2,2,0,2,"/2528868181315148597"
          "2022-01-01",1,1,0,1,"/4457889102355683190"
          "2022-01-01",1,1,0,1,"/12105301321223776356"
          "2022-01-01",2,2,0,2,"/6318438003888425693"
          "2022-01-01",2,2,0,2,"/5878724061840196349"
          "2022-01-01",1,1,0,1,"/1526239929864936398"
          "2022-01-01",2,2,0,2,"/7692634448754428624"
          "2022-01-01",4,4,0,4,"/12574817671425987843"
          "2022-01-01",1,1,0,1,"/14307781859600070983"
          "2022-01-01",2,2,0,2,"/7110820102771013606"
          "2022-01-01",3,3,0,3,"/14629996869565295116"
          "2022-01-01",2,2,0,2,"/64779230489549655"
          "2022-01-01",1,1,0,1,"/5551134200879446973"
          "2022-01-01",1,1,25,0,"/11888590162960019765"
          "2022-01-01",1,1,0,1,"/12567804068906971541"
          "2022-01-01",1,1,0,1,"/14033373606203782378"
          "2022-01-01",2,2,0,2,"/10341536794299767967"
          "2022-01-01",1,1,0,1,"/12766075726240916242"
          "2022-01-01",1,1,0,1,"/4362292817884281301"
          "2022-01-01",1,2,0,2,"/1250717791477281255"
          "2022-01-01",2,2,0,2,"/3457026921000639206"
          "2022-01-01",1,1,0,1,"/6077502147861556415"
          "2022-01-01",2,2,0,2,"/18342609412020394218"
          "2022-01-01",1,1,0,1,"/12189381298883635575"
          "2022-01-01",2,2,0,2,"/14280570555317344651"
          "2022-01-01",5,6,435,4,"/5284268072698982201"
          "2022-01-01",4,4,0,4,"/7478911940502018071"
          "2022-01-01",1,1,0,1,"/6402607186523575652"
          "2022-01-01",1,1,0,1,"/8587605562711759914"
          "2022-01-01",1,1,0,1,"/9962503789684934900"
          "2022-01-01",7,8,187,6,"/13595620304963848161"
          "2022-01-01",1,1,0,1,"/17019199732013993436"
          "2022-01-01",32,33,1195,29,"/9874837495456455794"
          "2022-01-02",3,3,81,2,"/14776416252794997127"
          "2022-01-02",3,6,33,5,"/9102354072466236765"
          "2022-01-02",1,1,0,1,"/17912324809189526683"
          "2022-01-02",1,1,0,1,"/2528868181315148597"
          "2022-01-02",1,1,0,1,"/4457889102355683190"
          "2022-01-02",1,1,0,1,"/4897404798407749335"
          "2022-01-02",1,1,0,1,"/5290432771315151230"
          "2022-01-02",1,1,0,1,"/3861893315241731546"
          "2022-01-02",1,1,0,1,"/12571626520250599954"
          "2022-01-02",11,11,832,10,"/12574817671425987843"
          "2022-01-02",2,2,0,2,"/15791285625100101971"
          "2022-01-02",2,2,0,2,"/16602440950175620202"
          "2022-01-02",1,1,0,1,"/3363270934034278688"
          "2022-01-02",6,6,122,5,"/14629996869565295116"
          "2022-01-02",1,2,0,2,"/17952015439202551610"
          """
        },
        %{
          name: "imported_exit_pages.csv",
          body: """
          "date","visitors","exits","exit_page"
          "2021-12-30",6,6,"/14776416252794997127"
          "2021-12-30",1,1,"/15455127321321119046"
          "2021-12-30",1,1,"/9102354072466236765"
          "2021-12-30",1,1,"/4457889102355683190"
          "2021-12-30",1,1,"/12105301321223776356"
          "2021-12-30",1,2,"/1526239929864936398"
          "2021-12-30",3,3,"/12574817671425987843"
          "2021-12-30",1,1,"/18226692671132987727"
          "2021-12-30",1,1,"/13530392472417087202"
          "2021-12-30",3,3,"/14629996869565295116"
          "2021-12-30",2,2,"/16500758973580097263"
          "2021-12-30",3,3,"/12300842990999856228"
          "2021-12-30",2,2,"/17859765562822550514"
          "2021-12-30",1,1,"/1250717791477281255"
          "2021-12-30",1,1,"/1586391735863371077"
          "2021-12-30",1,1,"/3457026921000639206"
          "2021-12-30",2,3,"/6077502147861556415"
          "2021-12-30",1,1,"/14280570555317344651"
          "2021-12-30",3,3,"/5284268072698982201"
          "2021-12-30",1,1,"/7478911940502018071"
          "2021-12-30",1,1,"/6402607186523575652"
          "2021-12-30",2,2,"/9962503789684934900"
          "2021-12-30",8,10,"/13595620304963848161"
          "2021-12-30",2,2,"/17019199732013993436"
          "2021-12-30",32,32,"/9874837495456455794"
          "2021-12-31",4,4,"/14776416252794997127"
          "2021-12-31",1,1,"/8738789417178304429"
          "2021-12-31",1,1,"/7445073500314667742"
          "2021-12-31",1,1,"/4897404798407749335"
          "2021-12-31",1,1,"/11263893625781431659"
          "2021-12-31",1,1,"/16478773157730928089"
          "2021-12-31",1,1,"/1710995203264225236"
          "2021-12-31",2,3,"/12574817671425987843"
          "2021-12-31",1,2,"/4072002299714740082"
          "2021-12-31",1,1,"/13544703054662457518"
          "2021-12-31",1,1,"/3363270934034278688"
          "2021-12-31",4,4,"/14629996869565295116"
          "2021-12-31",2,2,"/5918158559063394909"
          "2021-12-31",1,1,"/16500758973580097263"
          "2021-12-31",1,1,"/15335700069940448722"
          "2021-12-31",7,7,"/1250717791477281255"
          "2021-12-31",3,3,"/3457026921000639206"
          "2021-12-31",1,1,"/6077502147861556415"
          "2021-12-31",1,1,"/14280570555317344651"
          "2021-12-31",4,5,"/5284268072698982201"
          "2021-12-31",2,2,"/7478911940502018071"
          "2021-12-31",9,16,"/13595620304963848161"
          "2021-12-31",25,25,"/9874837495456455794"
          "2022-01-01",2,3,"/14776416252794997127"
          "2022-01-01",1,1,"/18394065791342797546"
          "2022-01-01",2,2,"/9102354072466236765"
          "2022-01-01",2,2,"/2528868181315148597"
          "2022-01-01",1,1,"/4457889102355683190"
          "2022-01-01",1,1,"/12105301321223776356"
          "2022-01-01",2,2,"/6318438003888425693"
          "2022-01-01",2,2,"/5878724061840196349"
          "2022-01-01",1,1,"/1526239929864936398"
          "2022-01-01",2,2,"/7692634448754428624"
          "2022-01-01",4,4,"/12574817671425987843"
          "2022-01-01",1,1,"/14307781859600070983"
          "2022-01-01",2,2,"/7110820102771013606"
          "2022-01-01",3,3,"/14629996869565295116"
          "2022-01-01",2,2,"/64779230489549655"
          "2022-01-01",1,1,"/5551134200879446973"
          "2022-01-01",1,1,"/11888590162960019765"
          "2022-01-01",1,1,"/12567804068906971541"
          "2022-01-01",1,1,"/14033373606203782378"
          "2022-01-01",2,2,"/10341536794299767967"
          "2022-01-01",1,1,"/12766075726240916242"
          "2022-01-01",1,1,"/4362292817884281301"
          "2022-01-01",1,2,"/1250717791477281255"
          "2022-01-01",2,2,"/3457026921000639206"
          "2022-01-01",1,1,"/6077502147861556415"
          "2022-01-01",2,2,"/18342609412020394218"
          "2022-01-01",1,1,"/12189381298883635575"
          "2022-01-01",2,2,"/14280570555317344651"
          "2022-01-01",5,6,"/5284268072698982201"
          "2022-01-01",4,4,"/7478911940502018071"
          "2022-01-01",1,1,"/6402607186523575652"
          "2022-01-01",1,1,"/8587605562711759914"
          "2022-01-01",1,1,"/9962503789684934900"
          "2022-01-01",7,8,"/13595620304963848161"
          "2022-01-01",1,1,"/17019199732013993436"
          "2022-01-01",32,33,"/9874837495456455794"
          "2022-01-02",4,4,"/14776416252794997127"
          "2022-01-02",3,5,"/9102354072466236765"
          "2022-01-02",1,1,"/17912324809189526683"
          "2022-01-02",1,1,"/2528868181315148597"
          "2022-01-02",1,1,"/4457889102355683190"
          "2022-01-02",1,1,"/4897404798407749335"
          "2022-01-02",1,1,"/5290432771315151230"
          "2022-01-02",1,1,"/3861893315241731546"
          "2022-01-02",1,1,"/12571626520250599954"
          "2022-01-02",10,10,"/12574817671425987843"
          "2022-01-02",1,1,"/15302856869047719385"
          "2022-01-02",2,2,"/15791285625100101971"
          "2022-01-02",2,2,"/16602440950175620202"
          "2022-01-02",1,1,"/3363270934034278688"
          "2022-01-02",6,6,"/14629996869565295116"
          "2022-01-02",1,2,"/17952015439202551610"
          """
        },
        %{
          name: "imported_locations.csv",
          body: """
          "date","country","region","city","visitors","visits","visit_duration","bounces"
          "2021-12-30","AU","",0,1,1,43,0
          "2021-12-30","AU","",2078025,3,4,211,3
          "2021-12-30","AU","",2147714,2,2,0,2
          "2021-12-30","AU","",2158177,2,2,0,2
          "2021-12-30","AU","",2174003,1,1,0,1
          "2021-12-30","BE","",0,1,1,0,1
          "2021-12-30","BE","",2792196,1,1,0,1
          "2021-12-30","BR","",0,1,1,0,1
          "2021-12-30","CA","",0,1,1,0,1
          "2021-12-30","CA","",5907364,1,1,0,1
          "2021-12-30","CA","",5918118,1,1,0,1
          "2021-12-30","CA","",5946768,1,1,0,1
          "2021-12-30","CA","",6066513,2,2,0,2
          "2021-12-30","CA","",6122091,1,1,0,1
          "2021-12-30","CA","",6141256,1,1,0,1
          "2021-12-30","CA","",6167865,1,1,0,1
          "2021-12-30","CN","",1784658,1,1,0,1
          "2021-12-30","CN","",1796236,1,1,0,1
          "2021-12-30","DE","",2865716,1,1,0,1
          "2021-12-30","DE","",2874225,1,1,0,1
          "2021-12-30","DE","",2950159,1,1,0,1
          "2021-12-30","DO","",3492908,2,2,0,2
          "2021-12-30","FR","",2996944,1,1,0,1
          "2021-12-30","GB","",2641523,1,1,0,1
          "2021-12-30","GB","",2643179,1,1,0,1
          "2021-12-30","GB","",2643743,1,1,0,1
          "2021-12-30","GB","",2644688,1,1,0,1
          "2021-12-30","GB","",2646504,1,1,0,1
          "2021-12-30","GB","",2653822,1,1,0,1
          "2021-12-30","IT","",3173435,1,1,0,1
          "2021-12-30","NL","",2747373,2,2,75,1
          "2021-12-30","PL","",0,1,1,0,1
          "2021-12-30","PL","",756135,1,1,0,1
          "2021-12-30","US","",0,1,1,0,1
          "2021-12-30","US","",0,1,1,0,1
          "2021-12-30","US","",0,1,1,0,1
          "2021-12-30","US","",0,1,1,0,1
          "2021-12-30","US","",4063926,1,1,0,1
          "2021-12-30","US","",4074013,1,3,0,3
          "2021-12-30","US","",4159077,1,1,0,1
          "2021-12-30","US","",4170688,1,1,0,1
          "2021-12-30","US","",4180183,1,1,0,1
          "2021-12-30","US","",4193699,1,1,0,1
          "2021-12-30","US","",4212992,1,1,0,1
          "2021-12-30","US","",4234436,1,1,0,1
          "2021-12-30","US","",4255836,1,1,0,1
          "2021-12-30","US","",4373238,1,1,0,1
          "2021-12-30","US","",4374798,1,1,0,1
          "2021-12-30","US","",4390705,1,1,0,1
          "2021-12-30","US","",4532846,1,1,0,1
          "2021-12-30","US","",4682665,1,1,0,1
          "2021-12-30","US","",4685987,1,1,0,1
          "2021-12-30","US","",4726311,1,1,0,1
          "2021-12-30","US","",4786619,1,1,0,1
          "2021-12-30","US","",4898015,1,1,0,1
          "2021-12-30","US","",4984247,1,1,0,1
          "2021-12-30","US","",5028537,2,2,0,2
          "2021-12-30","US","",5079991,1,1,0,1
          "2021-12-30","US","",5089478,1,1,0,1
          "2021-12-30","US","",5118743,1,1,0,1
          "2021-12-30","US","",5178713,1,1,0,1
          "2021-12-30","US","",5337561,1,1,0,1
          "2021-12-30","US","",5368361,1,1,0,1
          "2021-12-30","US","",5393049,1,1,0,1
          "2021-12-30","US","",5809844,2,3,0,3
          "2021-12-30","US","",5814916,1,2,0,2
          "2021-12-30","ZA","",0,1,1,0,1
          "2021-12-30","ZA","",0,1,1,0,1
          "2021-12-30","ZA","",936374,1,1,0,1
          "2021-12-30","ZA","",967106,1,1,0,1
          "2021-12-30","ZA","",1105777,1,1,0,1
          "2021-12-31","AU","",2078025,1,1,0,1
          "2021-12-31","AU","",2147714,3,3,0,3
          "2021-12-31","AU","",2158177,2,2,0,2
          "2021-12-31","CA","",0,1,1,0,1
          "2021-12-31","CA","",5907364,2,2,0,2
          "2021-12-31","CA","",5937615,1,1,0,1
          "2021-12-31","CA","",5990579,1,1,0,1
          "2021-12-31","CA","",6050610,1,1,0,1
          "2021-12-31","CA","",6087892,1,2,0,2
          "2021-12-31","CA","",6167865,3,3,0,3
          "2021-12-31","FR","",2988507,1,1,0,1
          "2021-12-31","GB","",0,1,1,0,1
          "2021-12-31","GB","",2640194,1,2,0,2
          "2021-12-31","GB","",2643743,2,2,0,2
          "2021-12-31","GB","",2644688,1,1,0,1
          "2021-12-31","GB","",2646274,1,1,0,1
          "2021-12-31","GB","",2654675,1,1,45,0
          "2021-12-31","GB","",2657562,1,1,0,1
          "2021-12-31","IE","",2964574,1,1,0,1
          "2021-12-31","IT","",3176959,1,1,85,0
          "2021-12-31","KR","",1835848,1,1,0,1
          "2021-12-31","LV","",456172,1,1,0,1
          "2021-12-31","MX","",3530757,2,3,0,3
          "2021-12-31","NL","",0,1,1,0,1
          "2021-12-31","NL","",0,1,2,0,2
          "2021-12-31","NL","",2745321,1,1,0,1
          "2021-12-31","NO","",0,1,1,199,0
          "2021-12-31","SE","",0,1,1,0,1
          "2021-12-31","SG","",1880252,1,1,0,1
          """
        },
        %{
          name: "imported_operating_systems.csv",
          body: """
          "date","operating_system","visitors","visits","visit_duration","bounces"
          "2021-12-30","Android",25,26,254,24
          "2021-12-30","Mac",13,16,0,16
          "2021-12-30","Windows",12,12,75,11
          "2021-12-30","iOS",30,31,0,31
          "2021-12-31","Android",15,16,329,13
          "2021-12-31","Mac",13,19,0,19
          "2021-12-31","Windows",7,7,496,5
          "2021-12-31","iOS",40,43,1957,40
          "2022-01-01","",17,18,0,18
          "2022-01-01","Android",25,28,32,26
          "2022-01-01","Chrome OS",1,1,0,1
          "2022-01-01","Mac",6,6,0,6
          "2022-01-01","Windows",9,9,1117,7
          "2022-01-01","iOS",38,40,693,35
          "2022-01-02","Android",21,21,1406,18
          "2022-01-02","Chrome OS",2,2,0,2
          "2022-01-02","Mac",18,18,86,16
          "2022-01-02","Windows",8,8,0,8
          "2022-01-02","iOS",54,61,1044,56
          "2022-01-03","Android",26,31,2009,26
          "2022-01-03","Chrome OS",1,1,58,0
          "2022-01-03","GNU/Linux",3,3,0,3
          "2022-01-03","Mac",25,25,1692,20
          "2022-01-03","Windows",8,8,105,7
          "2022-01-03","iOS",45,47,4355,40
          "2022-01-04","Android",21,22,250,20
          "2022-01-04","GNU/Linux",1,1,0,1
          "2022-01-04","Mac",18,18,1330,14
          "2022-01-04","Windows",7,7,0,7
          "2022-01-04","iOS",40,44,724,41
          "2022-01-05","Android",18,19,775,16
          "2022-01-05","Mac",12,12,1125,10
          "2022-01-05","Windows",18,20,37,19
          "2022-01-05","iOS",34,34,468,32
          "2022-01-06","",23,23,0,23
          "2022-01-06","Android",26,27,1793,23
          "2022-01-06","GNU/Linux",1,1,0,1
          "2022-01-06","Mac",16,16,0,16
          "2022-01-06","Windows",13,13,114,11
          "2022-01-06","iOS",35,40,1206,37
          "2022-01-07","Android",21,21,383,19
          "2022-01-07","Chrome OS",1,1,0,1
          "2022-01-07","Mac",6,6,0,6
          "2022-01-07","Windows",8,9,247,8
          "2022-01-07","iOS",27,28,856,25
          "2022-01-08","Android",26,26,163,25
          "2022-01-08","Chrome OS",1,1,0,1
          "2022-01-08","GNU/Linux",2,2,0,2
          "2022-01-08","Mac",17,18,405,15
          "2022-01-08","Windows",7,7,1766,5
          "2022-01-08","iOS",38,42,3769,37
          "2022-01-09","Android",15,16,151,14
          "2022-01-09","GNU/Linux",1,1,0,1
          "2022-01-09","Mac",19,20,554,16
          "2022-01-09","Windows",11,12,861,9
          "2022-01-09","iOS",41,46,301,44
          "2022-01-10","Android",11,13,0,13
          "2022-01-10","GNU/Linux",4,4,0,4
          "2022-01-10","Mac",13,15,0,15
          "2022-01-10","Windows",5,5,0,5
          "2022-01-10","iOS",39,40,160,37
          "2022-01-11","Android",19,19,68,16
          "2022-01-11","GNU/Linux",1,1,12,0
          "2022-01-11","Mac",14,14,700,10
          "2022-01-11","Windows",14,15,1123,13
          "2022-01-11","iOS",30,31,117,29
          "2022-01-12","Android",29,31,1735,26
          "2022-01-12","Chrome OS",1,1,1431,0
          "2022-01-12","GNU/Linux",1,1,0,1
          "2022-01-12","Mac",10,10,0,10
          "2022-01-12","Windows",4,4,112,3
          "2022-01-12","iOS",39,42,396,37
          "2022-01-13","Android",22,22,262,19
          "2022-01-13","Chrome OS",1,1,0,1
          "2022-01-13","Mac",18,19,2845,16
          "2022-01-13","Windows",15,15,155,12
          "2022-01-13","iOS",30,34,0,34
          "2022-01-14","Android",20,25,0,25
          "2022-01-14","Chrome OS",1,1,0,1
          "2022-01-14","GNU/Linux",1,1,0,1
          "2022-01-14","Mac",11,11,0,11
          "2022-01-14","Windows",8,8,5,7
          "2022-01-14","iOS",35,38,178,36
          "2022-01-15","Android",27,28,48,27
          "2022-01-15","Mac",15,15,347,14
          "2022-01-15","Windows",7,7,0,7
          "2022-01-15","iOS",50,52,3816,48
          "2022-01-16","Android",22,24,2292,20
          "2022-01-16","Chrome OS",1,1,0,1
          "2022-01-16","Mac",17,21,737,20
          "2022-01-16","Windows",12,12,92,9
          "2022-01-16","iOS",51,51,1595,45
          "2022-01-17","Android",25,29,1576,25
          "2022-01-17","GNU/Linux",2,2,0,2
          "2022-01-17","Mac",20,21,81,20
          "2022-01-17","Windows",19,19,469,17
          "2022-01-17","iOS",38,40,601,38
          "2022-01-18","Android",17,18,68,17
          "2022-01-18","Chrome OS",1,1,0,1
          "2022-01-18","GNU/Linux",3,3,0,3
          """
        },
        %{
          name: "imported_pages.csv",
          body: """
          "date","visitors","pageviews","exits","time_on_page","hostname","page"
          "2021-12-30",1,1,0,43,"lucky.numbers.com","/14776416252794997127"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/14776416252794997127"
          "2021-12-30",6,6,6,0,"lucky.numbers.com","/14776416252794997127"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/9102354072466236765"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/4457889102355683190"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/12105301321223776356"
          "2021-12-30",1,2,2,0,"lucky.numbers.com","/1526239929864936398"
          "2021-12-30",3,3,3,0,"lucky.numbers.com","/12574817671425987843"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/18226692671132987727"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/13530392472417087202"
          "2021-12-30",3,3,3,0,"lucky.numbers.com","/14629996869565295116"
          "2021-12-30",2,2,2,0,"lucky.numbers.com","/16500758973580097263"
          "2021-12-30",3,3,3,0,"lucky.numbers.com","/12300842990999856228"
          "2021-12-30",2,3,2,75,"lucky.numbers.com","/17859765562822550514"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/1250717791477281255"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/1586391735863371077"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/3457026921000639206"
          "2021-12-30",2,3,3,0,"lucky.numbers.com","/6077502147861556415"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/14280570555317344651"
          "2021-12-30",3,3,3,0,"lucky.numbers.com","/5284268072698982201"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/7478911940502018071"
          "2021-12-30",1,1,1,0,"lucky.numbers.com","/6402607186523575652"
          "2021-12-30",2,2,2,0,"lucky.numbers.com","/9962503789684934900"
          "2021-12-30",8,10,10,0,"lucky.numbers.com","/13595620304963848161"
          "2021-12-30",2,2,2,0,"lucky.numbers.com","/17019199732013993436"
          "2021-12-30",32,33,32,211,"lucky.numbers.com","/9874837495456455794"
          "2021-12-31",4,4,4,0,"lucky.numbers.com","/14776416252794997127"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/8738789417178304429"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/7445073500314667742"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/4897404798407749335"
          "2021-12-31",1,2,1,29,"lucky.numbers.com","/11263893625781431659"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/16478773157730928089"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/1710995203264225236"
          "2021-12-31",2,3,3,0,"lucky.numbers.com","/12574817671425987843"
          "2021-12-31",1,2,2,0,"lucky.numbers.com","/4072002299714740082"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/13544703054662457518"
          "2021-12-31",1,1,0,16,"lucky.numbers.com","/11454211114661615085"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/3363270934034278688"
          "2021-12-31",4,4,4,0,"lucky.numbers.com","/14629996869565295116"
          "2021-12-31",1,1,0,60,"lucky.numbers.com","/11880955414137016346"
          "2021-12-31",2,4,2,224,"lucky.numbers.com","/5918158559063394909"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/16500758973580097263"
          "2021-12-31",1,1,0,72,"lucky.numbers.com","/13683424886884591498"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/15335700069940448722"
          "2021-12-31",7,7,7,0,"lucky.numbers.com","/1250717791477281255"
          "2021-12-31",3,3,3,0,"lucky.numbers.com","/3457026921000639206"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/6077502147861556415"
          "2021-12-31",1,1,1,0,"lucky.numbers.com","/14280570555317344651"
          "2021-12-31",4,6,5,444,"lucky.numbers.com","/5284268072698982201"
          "2021-12-31",2,3,2,394,"lucky.numbers.com","/7478911940502018071"
          "2021-12-31",9,17,16,1455,"lucky.numbers.com","/13595620304963848161"
          "2021-12-31",25,27,25,88,"lucky.numbers.com","/9874837495456455794"
          "2022-01-01",2,3,3,0,"lucky.numbers.com","/14776416252794997127"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/18394065791342797546"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/9102354072466236765"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/2528868181315148597"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/4457889102355683190"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/12105301321223776356"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/6318438003888425693"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/5878724061840196349"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/1526239929864936398"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/7692634448754428624"
          "2022-01-01",4,4,4,0,"lucky.numbers.com","/12574817671425987843"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/14307781859600070983"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/7110820102771013606"
          "2022-01-01",3,3,3,0,"lucky.numbers.com","/14629996869565295116"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/64779230489549655"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/5551134200879446973"
          "2022-01-01",1,2,0,189,"lucky.numbers.com","/8000643558843134787"
          "2022-01-01",1,2,1,25,"lucky.numbers.com","/11888590162960019765"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/12567804068906971541"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/14033373606203782378"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/10341536794299767967"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/12766075726240916242"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/4362292817884281301"
          "2022-01-01",1,2,2,0,"lucky.numbers.com","/1250717791477281255"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/3457026921000639206"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/6077502147861556415"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/18342609412020394218"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/12189381298883635575"
          "2022-01-01",2,2,2,0,"lucky.numbers.com","/14280570555317344651"
          "2022-01-01",5,12,6,246,"lucky.numbers.com","/5284268072698982201"
          "2022-01-01",4,4,4,0,"lucky.numbers.com","/7478911940502018071"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/6402607186523575652"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/8587605562711759914"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/9962503789684934900"
          "2022-01-01",7,10,8,187,"lucky.numbers.com","/13595620304963848161"
          "2022-01-01",1,1,1,0,"lucky.numbers.com","/17019199732013993436"
          "2022-01-01",32,37,33,1195,"lucky.numbers.com","/9874837495456455794"
          "2022-01-02",4,5,4,81,"lucky.numbers.com","/14776416252794997127"
          "2022-01-02",3,6,5,33,"lucky.numbers.com","/9102354072466236765"
          "2022-01-02",1,1,1,0,"lucky.numbers.com","/17912324809189526683"
          "2022-01-02",1,1,1,0,"lucky.numbers.com","/2528868181315148597"
          "2022-01-02",1,1,1,0,"lucky.numbers.com","/4457889102355683190"
          "2022-01-02",1,1,1,0,"lucky.numbers.com","/4897404798407749335"
          "2022-01-02",1,1,1,0,"lucky.numbers.com","/5290432771315151230"
          "2022-01-02",1,1,1,0,"lucky.numbers.com","/3861893315241731546"
          "2022-01-02",1,1,1,0,"lucky.numbers.com","/12571626520250599954"
          "2022-01-02",11,12,10,660,"lucky.numbers.com","/12574817671425987843"
          "2022-01-02",1,1,1,0,"lucky.numbers.com","/15302856869047719385"
          """
        },
        %{
          name: "imported_sources.csv",
          body: """
          "date","source","utm_medium","utm_campaign","utm_content","utm_term","visitors","visits","visit_duration","bounces"
          "2021-12-30","","","","","",25,26,254,24
          "2021-12-30","Hacker News","referral","","","",2,2,0,2
          "2021-12-30","Google","organic","","","",20,22,75,21
          "2021-12-30","Pinterest","referral","","","",25,26,0,26
          "2021-12-30","baidu","organic","","","",1,1,0,1
          "2021-12-30","yahoo","organic","","","",3,3,0,3
          "2021-12-31","","","","","",16,16,199,15
          "2021-12-31","Bing","organic","","","",1,1,0,1
          "2021-12-31","DuckDuckGo","organic","","","",1,1,0,1
          "2021-12-31","Hacker News","referral","","","",1,1,466,0
          "2021-12-31","Google","organic","","","",25,32,85,31
          "2021-12-31","Pinterest","referral","","","",22,24,88,22
          "2021-12-31","yahoo","organic","","","",3,3,1899,1
          "2022-01-01","","","","","",37,38,1137,35
          "2022-01-01","Bing","organic","","","",2,2,171,1
          "2022-01-01","DuckDuckGo","organic","","","",2,3,0,3
          "2022-01-01","Hacker News","referral","","","",1,1,0,1
          "2022-01-01","Google","referral","","","",1,1,0,1
          "2022-01-01","Google","organic","","","",21,23,115,19
          "2022-01-01","Pinterest","referral","","","",29,30,0,30
          "2022-01-01","yahoo","organic","","","",3,3,419,2
          "2022-01-06","","","","","",37,38,430,36
          "2022-01-06","Bing","organic","","","how lucky am I as UInt64",1,1,0,1
          "2022-01-06","Bing","organic","","","",3,3,10,2
          """
        },
        %{
          name: "imported_visitors.csv",
          body: """
          "date","visitors","pageviews","bounces","visits","visit_duration"
          "2011-12-25",5,50,2,7,8640
          "2011-12-26",3,4,2,3,43
          "2011-12-27",3,6,2,4,2313
          "2011-12-28",6,30,4,8,2264
          "2011-12-29",4,8,5,6,136
          "2011-12-30",1,1,1,1,0
          "2012-01-01",3,15,0,3,1593
          "2012-01-02",1,1,1,1,0
          "2012-01-03",2,2,2,2,0
          "2012-01-04",5,12,2,5,1127
          "2012-01-05",2,2,2,2,0
          "2012-01-06",2,2,2,2,0
          "2012-01-07",3,7,2,3,80
          "2012-01-08",1,1,1,1,0
          "2012-01-13",2,2,2,2,0
          "2012-01-14",1,1,1,1,0
          "2012-01-15",2,6,1,2,82
          "2012-01-16",1,1,1,1,0
          "2012-01-17",1,1,1,1,0
          "2012-01-25",1,11,0,1,91
          "2012-01-26",3,9,1,3,146
          "2012-01-29",1,1,1,1,0
          "2012-02-03",1,2,0,1,6
          "2012-02-07",1,1,1,1,0
          "2012-02-27",1,1,1,1,0
          "2012-03-02",1,3,0,1,70
          "2012-03-18",1,1,1,1,0
          "2012-03-19",1,2,2,2,0
          "2012-03-21",1,2,0,1,22
          "2012-03-22",1,2,0,1,48
          "2012-03-28",1,3,0,1,208
          "2012-03-29",4,18,4,8,154
          "2012-04-15",1,1,1,1,0
          "2012-04-16",1,1,1,1,0
          "2012-04-24",1,1,1,1,0
          "2012-05-25",1,1,1,1,0
          "2012-05-31",1,1,1,1,0
          "2012-06-12",2,2,2,2,0
          "2012-07-01",1,2,0,1,6
          "2012-07-02",1,1,1,1,0
          "2012-07-19",1,1,1,1,0
          "2012-07-22",1,13,0,1,344
          "2012-07-23",5,26,2,7,936
          "2012-07-24",4,69,2,7,12746
          "2012-07-25",10,118,7,15,7815
          "2012-07-26",5,20,4,8,2172
          "2012-07-27",15,55,10,16,6712
          "2012-07-28",3,18,1,3,931
          "2012-07-29",3,3,2,3,6
          "2012-07-30",4,5,2,4,246
          "2012-07-31",6,40,2,7,3146
          "2012-08-01",3,52,2,8,5509
          "2012-08-02",77,127,68,78,3426
          "2012-08-03",28,38,24,29,1808
          "2012-08-04",11,38,9,15,5482
          "2012-08-05",14,46,12,17,3928
          "2012-08-06",11,58,5,14,9140
          "2012-08-07",17,112,13,21,12435
          "2012-08-08",31,53,25,34,2871
          "2012-08-09",14,23,7,15,265
          "2012-08-10",5,8,3,5,468
          "2012-08-11",4,13,2,6,1618
          "2012-08-12",4,5,3,4,4
          "2012-08-13",3,3,3,3,0
          "2012-08-14",3,3,3,3,0
          "2012-08-15",3,3,2,3,127
          "2012-08-16",5,8,3,5,231
          "2012-08-17",16,31,11,18,36929
          "2012-08-18",2,20,2,3,2121
          "2012-08-19",15,63,9,16,6688
          "2012-08-20",8,29,3,9,1884
          "2012-08-21",16,61,11,20,8529
          "2012-08-22",142,199,127,148,7577
          "2012-08-23",69,95,57,71,1339
          "2012-08-24",22,139,13,30,15027
          "2012-08-25",12,76,8,15,8813
          "2012-08-26",19,66,17,24,7716
          "2012-08-27",18,26,15,19,1968
          "2012-08-28",17,80,12,22,9624
          "2012-08-29",49,76,38,50,4581
          "2012-08-30",16,33,13,20,2441
          "2012-08-31",6,22,3,6,4429
          "2012-09-01",22,75,13,26,10118
          "2012-09-02",114,192,98,119,15659
          "2012-09-03",38,46,28,40,1208
          "2012-09-04",39,56,33,41,1686
          "2012-09-05",32,50,29,36,1000
          "2012-09-06",51,112,45,58,12959
          "2012-09-07",34,42,23,34,563
          "2012-09-08",110,189,97,111,12067
          "2012-09-09",69,81,62,70,1259
          "2012-09-10",18,37,14,21,1151
          "2012-09-11",27,45,20,32,3352
          "2012-09-12",17,38,11,18,3608
          "2012-09-13",24,68,14,27,11067
          "2012-09-14",15,28,10,17,977
          "2012-09-15",10,11,8,10,78
          "2012-09-16",7,7,7,7,0
          "2012-09-17",47,89,39,51,9309
          "2012-09-18",19,48,12,22,4102
          """
        }
      ]

      uploads =
        for %{name: name, body: body} <- csvs do
          key = "#{site.id}/#{name}"
          ExAws.request!(ExAws.S3.put_object("imports", key, body, content_type: "text/csv"))
          %{"filename" => name, "s3_path" => key}
        end

      {:ok, job} =
        CSVImporter.new_import(
          site,
          user,
          # to satisfy the non null constraints on the table I'm providing "0" dates (according to ClickHouse)
          start_date: ~D[1970-01-01],
          end_date: ~D[1970-01-01],
          uploads: uploads
        )

      job = Repo.reload!(job)

      assert :ok = Plausible.Workers.ImportAnalytics.perform(job)

      # on successfull import the start and end dates are updated
      assert %SiteImport{
               start_date: ~D[2011-12-25],
               end_date: ~D[2022-02-01],
               source: :csv,
               status: :completed
             } = Repo.get_by!(SiteImport, site_id: site.id)

      assert 3406 == Plausible.Stats.Clickhouse.imported_pageview_count(site)
    end

    test "invalid CSV"
  end
end
